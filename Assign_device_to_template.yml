- name: Commit config to real device
  hosts: fortimanager
  gather_facts: false
  connection: httpapi
  vars:
    ansible_httpapi_use_ssl: true
    ansible_httpapi_validate_certs: false
    ansible_httpapi_port: 443
    device_adom: "root"
    device_name: "Hub"
    device_vdom: "root"
  tasks:
    - name: Check device status
      fortinet.fortimanager.fmgr_fact:
        facts:
          selector: "dvmdb_device"
          params:
            adom: "{{ device_adom }}"
            device: "{{ device_name }}"
      register: device_status
      

    - name: Retrieve device configuration
      fortinet.fortimanager.fmgr_device_config:
        device_config:
          adom: "{{ device_adom }}"
          device: "{{ device_name }}"
          option: "retrieve"
      register: config_retrieve
      when: device_status is success

    - name: Invoke the task
      fortinet.fortimanager.fmgr_securityconsole_install_device:
        securityconsole_install_device:
          adom: "{{ device_adom }}"
          scope:
            - name: "{{ device_name }}"
              vdom: "{{ device_vdom }}"
      register: installing_task

    - name: Inspect the Task Status
      fortinet.fortimanager.fmgr_fact:
        facts:
          selector: "task_task"
          params:
            task: "{{ installing_task.meta.response_data.task }}"
      register: taskinfo
      until: taskinfo.meta.response_data.percent == 100
      retries: 30
      delay: 5
      

    - name: Display error details on failure
      ansible.builtin.debug:
        msg: "Task failed with details: {{ taskinfo.meta.response_data.history }}"
      when: taskinfo.meta.response_data.state == 'error'